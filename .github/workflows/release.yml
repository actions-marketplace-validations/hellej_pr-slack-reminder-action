name: Release

on:
  workflow_dispatch:
    inputs:
      semver:
        description: 'Whether to bump major, minor, or patch version'
        required: true
        default: minor
        type: choice
        options:
          - patch
          - minor
          - major
      commit-binary:
        description: 'Whether to commit the built binary to the repository'
        required: true
        default: true
        type: boolean

permissions:
  contents: write
  pull-requests: read

jobs:
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 #v6.0.1
      
      - name: Run unit tests
        uses: ./.github/actions/unit-tests

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: unit-tests

    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 #v6.0.1
        with:
          ssh-key: ${{ secrets.DEPLOY_KEY }}
      
      - name: Build application
        uses: ./.github/actions/build
        with:
          commit-binary: ${{ inputs.commit-binary }}

  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: build

    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 #v6.0.1
        with:
          ref: main

      - name: Run E2E tests
        uses: ./.github/actions/e2e-tests
        with:
          github-token: ${{ secrets.TEST_GITHUB_TOKEN }}
          slack-bot-token: ${{ secrets.DEV_SLACK_TOKEN }}

  release:
    name: Release
    runs-on: ubuntu-latest
    needs: e2e-tests

    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 #v6.0.1
        with:
          ref: main
          fetch-depth: 0

      - name: Configure Git
        shell: bash
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Create release tag
        shell: bash
        run: |
          echo "SEMVER input: ${{ inputs.semver }}"
          make release-tag SEMVER="${{ inputs.semver }}"

      - name: Create draft release
        id: create-release
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          RELEASE_OUTPUT=$(make draft-release)
          echo "$RELEASE_OUTPUT"
          RELEASE_URL=$(echo "$RELEASE_OUTPUT" | grep "Release URL:" | awk '{print $NF}')
          VERSION=$(echo "$RELEASE_OUTPUT" | grep "Latest tag:" | awk '{print $NF}')
          echo "release-url=$RELEASE_URL" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Notify Slack
        uses: slackapi/slack-github-action@91efab103c0de0a537f72a35f6b8cda0ee76bf0a #v2.1.1
        with:
          method: chat.postMessage
          token: ${{ secrets.DEV_SLACK_TOKEN }}
          payload: |
            channel: C0A0ES10NDR
            text: "New release draft created! ðŸš€"
            blocks:
              - type: "section"
                text:
                  type: "mrkdwn"
                  text: "New <${{ steps.create-release.outputs.release-url }}|draft release> created for *${{ steps.create-release.outputs.version }}* :rocket:"
